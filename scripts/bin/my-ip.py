#!/Users/josejavier/.pyenv/versions/anaconda3-5.0.1/bin/python
# <bitbar.title>external-ip</bitbar.title>
# <bitbar.author>Jose Javier Gonzalez Ortiz</bitbar.author>
# <bitbar.author.github>jjgo</bitbar.author.github>
# <bitbar.desc>Gets the current external IP address.</bitbar.desc>


import requests
import json
import subprocess
import sys

code2flag = {
    'AD': '🇦🇩',
    'AE': '🇦🇪',
    'AF': '🇦🇫',
    'AG': '🇦🇬',
    'AI': '🇦🇮',
    'AL': '🇦🇱',
    'AM': '🇦🇲',
    'AO': '🇦🇴',
    'AQ': '🇦🇶',
    'AR': '🇦🇷',
    'AS': '🇦🇸',
    'AT': '🇦🇹',
    'AU': '🇦🇺',
    'AW': '🇦🇼',
    'AX': '🇦🇽',
    'AZ': '🇦🇿',
    'BA': '🇧🇦',
    'BB': '🇧🇧',
    'BD': '🇧🇩',
    'BE': '🇧🇪',
    'BF': '🇧🇫',
    'BG': '🇧🇬',
    'BH': '🇧🇭',
    'BI': '🇧🇮',
    'BJ': '🇧🇯',
    'BL': '🇧🇱',
    'BM': '🇧🇲',
    'BN': '🇧🇳',
    'BO': '🇧🇴',
    'BQ': '🇧🇶',
    'BR': '🇧🇷',
    'BS': '🇧🇸',
    'BT': '🇧🇹',
    'BV': '🇧🇻',
    'BW': '🇧🇼',
    'BY': '🇧🇾',
    'BZ': '🇧🇿',
    'CA': '🇨🇦',
    'CC': '🇨🇨',
    'CD': '🇨🇩',
    'CF': '🇨🇫',
    'CG': '🇨🇬',
    'CH': '🇨🇭',
    'CI': '🇨🇮',
    'CK': '🇨🇰',
    'CL': '🇨🇱',
    'CM': '🇨🇲',
    'CN': '🇨🇳',
    'CO': '🇨🇴',
    'CR': '🇨🇷',
    'CU': '🇨🇺',
    'CV': '🇨🇻',
    'CW': '🇨🇼',
    'CX': '🇨🇽',
    'CY': '🇨🇾',
    'CZ': '🇨🇿',
    'DE': '🇩🇪',
    'DJ': '🇩🇯',
    'DK': '🇩🇰',
    'DM': '🇩🇲',
    'DO': '🇩🇴',
    'DZ': '🇩🇿',
    'EC': '🇪🇨',
    'EE': '🇪🇪',
    'EG': '🇪🇬',
    'EH': '🇪🇭',
    'ER': '🇪🇷',
    'ES': '🇪🇸',
    'ET': '🇪🇹',
    'FI': '🇫🇮',
    'FJ': '🇫🇯',
    'FK': '🇫🇰',
    'FM': '🇫🇲',
    'FO': '🇫🇴',
    'FR': '🇫🇷',
    'GA': '🇬🇦',
    'GB': '🇬🇧',
    'GD': '🇬🇩',
    'GE': '🇬🇪',
    'GF': '🇬🇫',
    'GG': '🇬🇬',
    'GH': '🇬🇭',
    'GI': '🇬🇮',
    'GL': '🇬🇱',
    'GM': '🇬🇲',
    'GN': '🇬🇳',
    'GP': '🇬🇵',
    'GQ': '🇬🇶',
    'GR': '🇬🇷',
    'GS': '🇬🇸',
    'GT': '🇬🇹',
    'GU': '🇬🇺',
    'GW': '🇬🇼',
    'GY': '🇬🇾',
    'HK': '🇭🇰',
    'HM': '🇭🇲',
    'HN': '🇭🇳',
    'HR': '🇭🇷',
    'HT': '🇭🇹',
    'HU': '🇭🇺',
    'ID': '🇮🇩',
    'IE': '🇮🇪',
    'IL': '🇮🇱',
    'IM': '🇮🇲',
    'IN': '🇮🇳',
    'IO': '🇮🇴',
    'IQ': '🇮🇶',
    'IR': '🇮🇷',
    'IS': '🇮🇸',
    'IT': '🇮🇹',
    'JE': '🇯🇪',
    'JM': '🇯🇲',
    'JO': '🇯🇴',
    'JP': '🇯🇵',
    'KE': '🇰🇪',
    'KG': '🇰🇬',
    'KH': '🇰🇭',
    'KI': '🇰🇮',
    'KM': '🇰🇲',
    'KN': '🇰🇳',
    'KP': '🇰🇵',
    'KR': '🇰🇷',
    'KW': '🇰🇼',
    'KY': '🇰🇾',
    'KZ': '🇰🇿',
    'LA': '🇱🇦',
    'LB': '🇱🇧',
    'LC': '🇱🇨',
    'LI': '🇱🇮',
    'LK': '🇱🇰',
    'LR': '🇱🇷',
    'LS': '🇱🇸',
    'LT': '🇱🇹',
    'LU': '🇱🇺',
    'LV': '🇱🇻',
    'LY': '🇱🇾',
    'MA': '🇲🇦',
    'MC': '🇲🇨',
    'MD': '🇲🇩',
    'ME': '🇲🇪',
    'MF': '🇲🇫',
    'MG': '🇲🇬',
    'MH': '🇲🇭',
    'MK': '🇲🇰',
    'ML': '🇲🇱',
    'MM': '🇲🇲',
    'MN': '🇲🇳',
    'MO': '🇲🇴',
    'MP': '🇲🇵',
    'MQ': '🇲🇶',
    'MR': '🇲🇷',
    'MS': '🇲🇸',
    'MT': '🇲🇹',
    'MU': '🇲🇺',
    'MV': '🇲🇻',
    'MW': '🇲🇼',
    'MX': '🇲🇽',
    'MY': '🇲🇾',
    'MZ': '🇲🇿',
    'NA': '🇳🇦',
    'NC': '🇳🇨',
    'NE': '🇳🇪',
    'NF': '🇳🇫',
    'NG': '🇳🇬',
    'NI': '🇳🇮',
    'NL': '🇳🇱',
    'NO': '🇳🇴',
    'NP': '🇳🇵',
    'NR': '🇳🇷',
    'NU': '🇳🇺',
    'NZ': '🇳🇿',
    'OM': '🇴🇲',
    'PA': '🇵🇦',
    'PE': '🇵🇪',
    'PF': '🇵🇫',
    'PG': '🇵🇬',
    'PH': '🇵🇭',
    'PK': '🇵🇰',
    'PL': '🇵🇱',
    'PM': '🇵🇲',
    'PN': '🇵🇳',
    'PR': '🇵🇷',
    'PS': '🇵🇸',
    'PT': '🇵🇹',
    'PW': '🇵🇼',
    'PY': '🇵🇾',
    'QA': '🇶🇦',
    'RE': '🇷🇪',
    'RO': '🇷🇴',
    'RS': '🇷🇸',
    'RU': '🇷🇺',
    'RW': '🇷🇼',
    'SA': '🇸🇦',
    'SB': '🇸🇧',
    'SC': '🇸🇨',
    'SD': '🇸🇩',
    'SE': '🇸🇪',
    'SG': '🇸🇬',
    'SH': '🇸🇭',
    'SI': '🇸🇮',
    'SJ': '🇸🇯',
    'SK': '🇸🇰',
    'SL': '🇸🇱',
    'SM': '🇸🇲',
    'SN': '🇸🇳',
    'SO': '🇸🇴',
    'SR': '🇸🇷',
    'SS': '🇸🇸',
    'ST': '🇸🇹',
    'SV': '🇸🇻',
    'SX': '🇸🇽',
    'SY': '🇸🇾',
    'SZ': '🇸🇿',
    'TC': '🇹🇨',
    'TD': '🇹🇩',
    'TF': '🇹🇫',
    'TG': '🇹🇬',
    'TH': '🇹🇭',
    'TJ': '🇹🇯',
    'TK': '🇹🇰',
    'TL': '🇹🇱',
    'TM': '🇹🇲',
    'TN': '🇹🇳',
    'TO': '🇹🇴',
    'TR': '🇹🇷',
    'TT': '🇹🇹',
    'TV': '🇹🇻',
    'TW': '🇹🇼',
    'TZ': '🇹🇿',
    'UA': '🇺🇦',
    'UG': '🇺🇬',
    'UM': '🇺🇲',
    'US': '🇺🇸',
    'UY': '🇺🇾',
    'UZ': '🇺🇿',
    'VA': '🇻🇦',
    'VC': '🇻🇨',
    'VE': '🇻🇪',
    'VG': '🇻🇬',
    'VI': '🇻🇮',
    'VN': '🇻🇳',
    'VU': '🇻🇺',
    'WF': '🇼🇫',
    'WS': '🇼🇸',
    'YE': '🇾🇪',
    'YT': '🇾🇹',
    'ZA': '🇿🇦',
    'ZM': '🇿🇲',
    'ZW': '🇿🇼',
}


def write_to_clipboard(output):
    process = subprocess.Popen(
        'pbcopy', env={'LANG': 'en_US.UTF-8'}, stdin=subprocess.PIPE)
    process.communicate(output.encode('utf-8'))


r = requests.get('http://ipinfo.io')
r = json.loads(r.content.decode())


external_ip = r['ip']

flag = code2flag[r['country']]
if r['org'] == 'AS3 Massachusetts Institute of Technology':
    if external_ip.startswith('18'):        # MIT
        flag = '🏛️'  # '📕'
    elif external_ip.startswith('128'):     # CSAIL
        flag = '🏭'  # '🔸📙'

if len(sys.argv) > 1:
    if sys.argv[1] == 'copy':
        write_to_clipboard(external_ip)
        # sys.exit(0)

# print(f"{external_ip}{flag}")
print(f"{flag}")
print("---")
print(f"External IP address: {external_ip}")
print(f"Copy External IP | terminal=false bash='{sys.argv[0]}' param1=copy")
print("---")

interfaces = [f'en{i}' for i in [1, 2, 3, 4, 5, 6, 0]] # Wireless last

for interface in interfaces:
    cmd = ['ipconfig', 'getifaddr', interface]
    p = subprocess.run(cmd, stdout=subprocess.PIPE)
    if p.returncode == 0:
        internal_ip = p.stdout.decode().strip()
        if interface == 'en0':
            print(f"Wireless IP: {internal_ip}")
        else:
            print(f"Wired IP {interface}: {internal_ip}")
